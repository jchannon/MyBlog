{{ define "main" }}
<article class="post">
  <header class="post-header">
    <h1 class="post-title">{{ .Title }}</h1>
    
    <div class="post-meta">
      <span class="post-date">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
        <time datetime="{{ .Date.Format "2006-01-02" }}">{{ .Date.Format "January 2, 2006" }}</time>
      </span>
      
      {{- with .Params.tags }}
      <div class="tags">
        {{- range . }}
        <a href="{{ "tags/" | relURL }}{{ . | urlize }}/" class="tag">{{ . }}</a>
        {{- end }}
      </div>
      {{- end }}
    </div>
  </header>
  
  <div class="post-content">
    {{ .Content }}
  </div>
  
  <div class="giscus-wrapper">
    <script src="https://giscus.app/client.js"
            data-repo="jchannon/MyBlog"
            data-repo-id="MDEwOlJlcG9zaXRvcnkyNjE3NzA0MTI="
            data-category="Announcements"
            data-category-id="DIC_kwDOD5pMrM4C0RH8"
            data-mapping="pathname"
            data-strict="1"
            data-reactions-enabled="1"
            data-emit-metadata="0"
            data-input-position="top"
            data-theme="light"
            data-lang="en"
            crossorigin="anonymous"
            async>
    </script>
  </div>
  
  <script>
    (function() {
      // Update giscus theme when page theme changes
      function updateGiscusTheme() {
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        const giscusTheme = isDark ? 'dark_dimmed' : 'light';
        
        // Send message to giscus iframe
        const giscusFrame = document.querySelector('iframe.giscus-frame');
        if (giscusFrame) {
          giscusFrame.contentWindow.postMessage(
            {
              giscus: {
                setConfig: {
                  theme: giscusTheme
                }
              }
            },
            'https://giscus.app'
          );
        }
      }
      
      // Wait for Giscus iframe to load, then set initial theme
      function initializeGiscusTheme() {
        const giscusFrame = document.querySelector('iframe.giscus-frame');
        if (giscusFrame) {
          updateGiscusTheme();
        } else {
          // Observe the giscus-wrapper for child additions
          const giscusWrapper = document.querySelector('.giscus-wrapper');
          if (giscusWrapper) {
            // Use MutationObserver to watch for iframe being added
            const observer = new MutationObserver(function() {
              const giscusFrame = document.querySelector('iframe.giscus-frame');
              if (giscusFrame) {
                updateGiscusTheme();
                observer.disconnect();
              }
            });
            
            observer.observe(giscusWrapper, { childList: true, subtree: true });
          }
        }
      }
      
      // Initialize theme on page load
      document.addEventListener('DOMContentLoaded', function() {
        initializeGiscusTheme();
        
        // Watch for system theme changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
          // Only auto-update if user hasn't set an explicit preference
          const hasStoredPreference = localStorage.getItem('theme');
          if (!hasStoredPreference) {
            // Update page theme to match system preference
            if (e.matches) {
              document.documentElement.setAttribute('data-theme', 'dark');
            } else {
              document.documentElement.removeAttribute('data-theme');
            }
          }
          // Update Giscus theme to match current page theme
          updateGiscusTheme();
        });
      });
      
      // Watch for theme toggle button clicks
      const themeToggle = document.getElementById('theme-toggle');
      if (themeToggle) {
        themeToggle.addEventListener('click', function() {
          // Wait a moment for the theme to update
          setTimeout(updateGiscusTheme, 50);
        });
      }
    })();
  </script>
</article>
{{ end }}
