<!DOCTYPE HTML>

<html lang='en'>
	<head>
		<title>Porting OWIN middleware to ASP.Net Core &middot; Jonathan Channon Blog</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		
		
		
		<link rel="stylesheet" href="/assets/css/main.min.css">
		
		
		
		<noscript><link rel="stylesheet" href='/assets/css/noscript.css' /></noscript>
	</head>

	<body lang='en' class="is-preload">

		
			<div id="wrapper">

                
<header id="header">
    <a href='/' class="logo">Blog</a>
</header>

                

<nav id="nav">
    <ul class="links">
        <li class="active"><a href='/'>Blog</a></li>
        
        
    </ul>
    
    <ul class="icons">
        
        <li><a href="https://twitter.com/jchannon" class="icon fa-twitter"><span class="label">Twitter</span></a></li>
        
        
        <li><a href="https://github.com/jchannon" class="icon fa-github"><span class="label">GitHub</span></a></li>
        
        
        
        
        <li><a href="https://www.linkedin.com/in/jonathanchannon/" class="icon fa-linkedin"><span class="label">LinkedIn</span></a></li>
        
        
        
        
        
    </ul>
    
</nav>


				
					<div id="main">

						
                        <section class="post">
                            <header class="major">
                                
                                <span class="date">Mon, Jun 27, 2016</span>
                                
                                <h1>Porting OWIN middleware to ASP.Net Core</h1>
                                <p></p>
                            </header>
                            
                            <p>In our application at work we make use of various middleware and as we are making everything run on .Net Core the time has come to port said middleware to .Net Core.  If you don&rsquo;t already know ASP.Net Core has a bridge that allows you to use OWIN components in an ASP.Net Core application.  This will convert the HttpContext into a OWIN environment dictionary on input and then back again on output.</p>
<p>Lets take an example of some middleware</p>
<pre><code>public class MyMiddleware
{
    private readonly Func&lt;IDictionary&lt;string, object&gt;, Task&gt; nextFunc;
    private readonly OwinUserMiddlewareOptions options;

    public OwinUserMiddleware(Func&lt;IDictionary&lt;string, object&gt;, Task&gt; nextFunc, MyMiddlewareOptions options)
    {
        this.options = options;
        this.nextFunc = nextFunc;
    }

    public Task Invoke(IDictionary&lt;string, object&gt; environment)
    {
        //Everything is awesome
        return nextFunc(environment);
    }
}

public static class MyMiddlewareExtensions
{
    public static IAppBuilder UseMyMiddleware(this IAppBuilder app, MyMiddlewareOptions options = null)
    {
        return app.Use(typeof(MyMiddleware), options);
    }
}
</code></pre>
<p>Here we see some middleware and an extension so it can be used in an application that uses OWIN.  This would be called in most commonly in a <code>Startup.cs</code> file like so:</p>
<pre><code>public void Configuration(IAppBuilder app)
{
    app.UseMyMiddleware(new MyMiddlewareOptions());  
}
</code></pre>
<p>As I said earlier, ASP.Net Core has a bridge to use OWIN components and as long as your middleware can return a <code>MidFunc</code> there is very little required for you to do however if you take the example above there is a tiny bit more to do.</p>
<h2 id="aspnet-core-startupcs">ASP.Net Core Startup.cs</h2>
<pre><code>public void Configure(IApplicationBuilder app)
{
    //Use the ASP.Net Core OWIN bridge
    app.UseOwin(x =&gt; x.Invoke(MyMiddleware.ReturnAppFunc()));  
}
</code></pre>
<p>Above shows how to use the OWIN bridge if your middleware can already return a <code>MidFunc</code>.  For those unclear here&rsquo;s what that looks like <code>System.Func&lt;System.Func&lt;System.Collections.Generic.IDictionary&lt;string, object&gt;, System.Threading.Tasks.Task&gt;, System.Func&lt;System.Collections.Generic.IDictionary&lt;string, object&gt;, System.Threading.Tasks.Task&gt;&gt;;</code></p>
<p>Using our sample middleware above the extension class would now have to look like this:</p>
<pre><code>using System;

using MidFunc = System.Func&lt;System.Func&lt;System.Collections.Generic.IDictionary&lt;string, object&gt;,
        System.Threading.Tasks.Task&gt;, System.Func&lt;System.Collections.Generic.IDictionary&lt;string, object&gt;,
        System.Threading.Tasks.Task&gt;&gt;;

public static class MyMiddlewareExtensions
{
    public static Action&lt;MidFunc&gt; UseMyMiddleware(this Action&lt;MidFunc&gt; builder, MyMiddlewareOptions options = null)
    {
        builder(next =&gt; new MyMiddleware(next, options).Invoke);
        return builder;
    }
}
</code></pre>
<p>This can now be used in a ASP.NET Core Startup class like so:</p>
<pre><code>public void Configure(IApplicationBuilder app)
{
  //Use the ASP.Net Core OWIN bridge
  app.UseOwin(x =&gt; 
  {
      x.UseMyMiddleware(new MyMiddlewareOptions());
      x.UseNancy();
  });  
}
</code></pre>
<p>Tada!  Also note that I only call <code>UseOwin</code> once, I don&rsquo;t need to call it for every OWIN middleware I have.  Also just to be clear, if you want your middleware to run on .Net Core you will still have to make sure your middleware is compatible.  The above shows  how you came make your OWIN middleware run in ASP.Net Core pipeline even if its on .Net 4.5 but if it is compatible with .Net Core you can target that from your application and bingo! That is exactly what I have done with my middleware.</p>
<p>Happy coding!</p>

                            
                            
                            
                            <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "jonathanchannonblog" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                            
                        </section>

					</div>

                    

<footer id="footer">
    
    <section class="split contact">
        
        
        
        
        <section>
            <h3>Social</h3>
            <ul class="icons alt">
                
                <li><a href="https://twitter.com/jchannon" class="icon alt fa-twitter"><span class="label">Twitter</span></a></li>
                
                
                <li><a href="https://github.com/jchannon" class="icon alt fa-github"><span class="label">GitHub</span></a></li>
                
                
                
                
                <li><a href="https://www.linkedin.com/in/jonathanchannon/" class="icon alt fa-linkedin"><span class="label">LinkedIn</span></a></li>
                
                
                
                
                
            </ul>
        </section>
        
    </section>
</footer>

                    
<div id="copyright">
    <ul><li>&copy; Blog</li><li>Design: <a href="https://html5up.net">HTML5 UP</a></li><li>Hugo Port: <a href="https://curtistimson.co.uk">curttimson</a></li></ul>
</div>


            </div>
            
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-7138405-4', 'auto');
	
	ga('send', 'pageview');
}
</script>
            










<script src='/assets/js/bundle.js'></script>


	</body>
</html>
