<!DOCTYPE HTML>

<html lang='en'>
	<head>
		<title>Abstracting the File System &middot; Jonathan Channon Blog</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		
		
		
		<link rel="stylesheet" href="/assets/css/main.min.css">
		
		
		
		<noscript><link rel="stylesheet" href='/assets/css/noscript.css' /></noscript>
	</head>

	<body lang='en' class="is-preload">

		
			<div id="wrapper">

                
<header id="header">
    <a href='/' class="logo">Blog</a>
</header>

                

<nav id="nav">
    <ul class="links">
        <li class="active"><a href='/'>Blog</a></li>
        
        
    </ul>
    
    <ul class="icons">
        
        <li><a href="https://twitter.com/jchannon" class="icon fa-twitter"><span class="label">Twitter</span></a></li>
        
        
        <li><a href="https://github.com/jchannon" class="icon fa-github"><span class="label">GitHub</span></a></li>
        
        
        
        
        <li><a href="https://www.linkedin.com/in/jonathanchannon/" class="icon fa-linkedin"><span class="label">LinkedIn</span></a></li>
        
        
        
        
        
    </ul>
    
</nav>


				
					<div id="main">

						
                        <section class="post">
                            <header class="major">
                                
                                <span class="date">Fri, Sep 28, 2012</span>
                                
                                <h1>Abstracting the File System</h1>
                                <p></p>
                            </header>
                            
                            <p>Following on from my post about <a href="http://blog.jonathanchannon.com/2012/09/25/is-oss-good-for-your-career/">OSS</a> I thought I would illustrate how cool OSS can be.</p>
<p>The day before that post was published I was working on a program that required the file system. All you good developers are going to know that the file system is a dependency and dependencies are bad and this post will probably be a bit like preaching to the choir however I thought it was worth posting.</p>
<p>So you have a a method similar to this:</p>
<pre><code>public void DoSomethingCool()
{
  //do some stuff now write to file

  FileInfo f = new FileInfo(&quot;C:\Mytext.txt&quot;)
  using(StreamWriter w = f.CreateText())
  {
    w.WriteLine(&quot;This blog post is cool&quot;);
    w.Close();
  }
}
</code></pre>
<p>You are writing to a file to record something and need to test your method. Remember, unit tests are supposed to be fast. Typically anything that writes to a database or a file system will be slow however, we also have the problem that our method is now dependent on the file system and dependencies are bad. Wouldn’t it be handy if we could make FileInfo a representation of an interface.</p>
<p>Simplest way is to hit F12 in Visual Studio and see what interface FileInfo implements.</p>
<p>We get this:</p>
<pre><code>public sealed class FileInfo : FileSystemInfo
</code></pre>
<p>Hmmm, OK lets hit F12 on FileSystemInfo and we get</p>
<pre><code>public abstract class FileSystemInfo : MarshalByRefObject, ISerializable
</code></pre>
<p>So it looks like the FileInfo class does not implement any interface so now we’re stuck, we have a hard coded dependency and our unit tests are going to be slow.</p>
<p>The answer is we’ll have to create an interface for all the methods and properties that we are going to use that are in FileInfo. Not too bad I suppose, we’re only using CreateText in the example above so we create:</p>
<pre><code>public interface IFileInfo
{
  StreamWriter CreateText();
}
</code></pre>
<p>We can now pass in IFileInfo to our class’ constructor and hopefully use it like so:</p>
<pre><code>public class MyClass
{
  private readonly IFileInfo fileInfo;

  public MyClass(IFileInfo fileInfo)
  {
    this.fileInfo = fileInfo;
  }

  public void DoSomethingCool()
  {
    //do some stuff now write to file

    using(StreamWriter w = fileInfo.CreateText())
    {
      w.WriteLine(&quot;This blog post is cool&quot;);
      w.Close();
    }
  }
}
</code></pre>
<p>We could then use <a href="https://code.google.com/p/moq/">Moq</a> in our unit test to successfully mock the filesystem and ensure our method writes to the file:</p>
<pre><code>[TestFixture]
public class MyTestClass
{
  [Test]
  public void DoSomethingCool_WhenCalled_WritesToFile()
  {
    //Arrange
    var fileMock = new Moq.Mock&lt;IFileInfo&gt;();
    var myClass = new MyClass(fileMock.Object);
       
    //Act
    myClass.DoSomethingCool();

    //Assert
    fileMock.Verify(x =&amp;gt; x.CreateText());
  }
}
</code></pre>
<p>As you’ve probably spotted there are three issues here. Firstly FileInfo expects a path in its constructor which we haven’t supplied, secondly all we’ve actually verified in our test is that CreateText is called and finally DoSomethingCool still has a dependency on StreamWriter which uses the underlying file system. The solution is to abstract the StreamWriter yourself so the unit test is testing that data is written to the file and do something about the FileInfo dependency.</p>
<p>It could be done, not a problem, but wouldn’t it be nice if someone has already done that for you? Luckily they have and its called <a href="https://github.com/tathamoddie/System.IO.Abstractions">System.IO.Abstractions</a>.</p>
<p>A quote from the website &ldquo;<em>At the core of the library is IFileSystem and FileSystem. Instead of calling methods like File.ReadAllText directly, use IFileSystem.File.ReadAllText. We have exactly the same API, except that ours is injectable and testable.</em>&rdquo;</p>
<p>What this means is that you can now do:</p>
<pre><code>public class MyClass
{
    private readonly IFileSystem fileSystem;

    public MyClass(IFileSystem  fileSystem)
    {
      this.fileSystem = fileSystem;
    }

    public void DoSomethingCool()
    {
      //do some stuff now write to file

      var file = fileSystem.FileInfo.FromFileName(&quot;C:\Mytext.txt&quot;);
      using(IStreamWriter writer = file.CreateText())
      {
        writer.WriteLine(&quot;This blog post is cool&quot;);
        writer.Close();
      }
    }
}

[TestFixture]
public class MyTestClass
{
    [Test]
    public void DoSomethingCool_WhenCalled_WritesToFile()
    {
      //Arrange
      var filesystemMock = new Moq.Mock&lt;IFileSystem&gt;();
      var fileinfoFactory = new Moq.Mock&lt;IFileInfoFactory&gt;();
      var fileinfoMock = new Moq.Mock&lt;FileInfoBase&gt;();
      var streamWriterMock = new Moq.Mock&lt;IStreamWriter&gt;();

      var myClass = new MyClass(filesystemMock.Object);

      fileinfoMock.Setup(x =&gt; x.CreateText()).Returns(streamWriterMock.Object);
      fileinfoFactory.Setup(x =&gt; x.FromFileName(&quot;C:\Mytext.txt&quot;)).Returns(fileinfoMock.Object);
      filesystemMock.Setup(x =&gt; x.FileInfo).Returns(fileinfoFactory.Object);

      //Act
      myClass.DoSomethingCool();

      //Assert
      streamWriterMock.Verify(x =&gt; x.WriteLine(&quot;This blog post is cool&quot;));
    }
}
</code></pre>
<p>You can now still verify your calls to file are getting called but on top of that you can verify the content written to file all without the need for a file system.</p>
<p>Now some of you may not like all the mocks arranged in the unit test so luckily for you System.IO.Abstractions has a set of its own mocks that you can use. This means we have to modify our class slightly to make the filesystem public so we can read what is written to file:</p>
<pre><code>public class MyClass
{
    public readonly IFileSystem filesystem;

    public MyClass(IFileSystem filesystem)
    {
      this.filesystem = filesystem;
    }

    public void DoSomethingCool()
    {
      //do some stuff now write to file

      using(var w = filesystem.FileInfo.FromFileName(&quot;C:\\Mytext.txt&quot;).CreateText())
      {
        w.WriteLine(&quot;This blog post is cool&quot;);
        w.Close();
      }
    }
}

[TestFixture]
public class MyTestClass
{
    [Test]
    public void DoSomethingCool_WhenCalled_WritesToFile()
    {
      //Arrange
      var fileData = new MockFileData(&quot;&quot;);
      var fileSystem = new MockFileSystem(new Dictionary&lt;string, MockFileData&gt;
      {
          { &quot;C:\\Mytext.txt&quot;, fileData }
      });

      var myClass = new MyClass(fileSystem);
        
      //Act
      myClass.DoSomethingCool();

      //Assert
      MockFileInfoFactory factory = (MockFileInfoFactory)myClass.filesystem.FileInfo;
      var result = factory.FileInfo.OpenText().ReadToEnd();
      Assert.AreEqual(&quot;This blog post is cool&quot;, result);
    }
}
</code></pre>
<p>Its a matter of preference which you prefer but either way hopefully this illustrates how and why you should abstract the file system</p>
<p>One thing to point out is that these file system calls should be in their own class and that DoSomethingCool should be calling something like IFileSystemLogger.Log() which is where the file system calls should be. This illustrates the <a href="http://en.wikipedia.org/wiki/Single_responsibility_principle">Single Responsibility Principle</a></p>
<p><strong>Some of the functionality outlined above is not available yet in the master branch of System.IO.Abstractions but it has been submitted as a pull request from me so hopefully it will be merged soon. I’ve already had one PR merged and it was quick, built and released on NuGet within the hour. I encourage you to take a look at this project and try and contribute. There are a few quirks, for example, I wanted to use Moq v4 syntax in my tests but couldn’t work it out, not sure if that’s me or System.IO.Abstractions. Anyhow the more people that get involved the better it will become.</strong></p>

                            
                            
                            
                            <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "jonathanchannonblog" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                            
                        </section>

					</div>

                    

<footer id="footer">
    
    <section class="split contact">
        
        
        
        
        <section>
            <h3>Social</h3>
            <ul class="icons alt">
                
                <li><a href="https://twitter.com/jchannon" class="icon alt fa-twitter"><span class="label">Twitter</span></a></li>
                
                
                <li><a href="https://github.com/jchannon" class="icon alt fa-github"><span class="label">GitHub</span></a></li>
                
                
                
                
                <li><a href="https://www.linkedin.com/in/jonathanchannon/" class="icon alt fa-linkedin"><span class="label">LinkedIn</span></a></li>
                
                
                
                
                
            </ul>
        </section>
        
    </section>
</footer>

                    
<div id="copyright">
    <ul><li>&copy; Blog</li><li>Design: <a href="https://html5up.net">HTML5 UP</a></li><li>Hugo Port: <a href="https://curtistimson.co.uk">curttimson</a></li></ul>
</div>


            </div>
            
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-7138405-4', 'auto');
	
	ga('send', 'pageview');
}
</script>
            










<script src='/assets/js/bundle.js'></script>


	</body>
</html>
